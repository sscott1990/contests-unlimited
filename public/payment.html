<!DOCTYPE html>
<html>
<head>
  <title>Enter Contest</title>
  <link rel="stylesheet" href="/styles.css">
  <script 
    src="https://secure.easypaydirectgateway.com/token/CollectCheckout.js"
    data-checkout-key="checkout_public_N3P2EnN845nGgYERKq3rsdqXD397D787">
  </script>
  <style>
    #checkout_button {
      display: inline-block;
      font-family: sans-serif;
      font-size: 20px;
      background-color: #0BD992;
      color: white;
      border-radius: 4px;
      padding: 14px 28px;
      margin-top: 20px;
    }
    #checkout_button:hover {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Enter Contest - $5 Entry</h1>

  <div id="checkout_button">Pay $5</div>

  <p style="margin-top: 20px; font-size: 0.95em; color: #444;">
    üèÜ Winners will be contacted via email and asked to provide their full name and mailing address to issue the prize check.
  </p>

  <script>
    window.addEventListener('DOMContentLoaded', function () {
      document.getElementById('checkout_button').addEventListener('click', async function () {
        try {
          // Call your backend to create a checkout session
          const response = await fetch('/api/payment/create-checkout-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          if (!response.ok) {
            throw new Error('Failed to create checkout session');
          }
          const data = await response.json();
          const sessionId = data.id;
          if (!sessionId) {
            throw new Error('No session ID returned');
          }

          // Redirect user to EasyPayDirect checkout using the session ID
          CollectCheckout.redirectToCheckout({
            type: "sale",
            sessionId: sessionId,  // Use sessionId here
            successUrl: `https://contests-unlimited.onrender.com/success.html?session_id=${sessionId}`,
            cancelUrl: "https://contests-unlimited.onrender.com/cancel.html",
            paymentMethods: [
              { type: "creditCard", use3DSecure: false },
              { type: "check" }
            ]
          }).then(result => {
            if (result && result.error) {
              console.error('Checkout error:', result.error);
              alert("There was an error during checkout. Please try again.");
            }
          }).catch(err => {
            console.error('Unexpected error:', err);
            alert("Unexpected error occurred. Please try again later.");
          });

        } catch (error) {
          console.error('Error creating checkout session:', error);
          alert("Unable to start payment. Please try again later.");
        }
      });
    });
  </script>
</body>
</html>
