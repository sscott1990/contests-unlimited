<!DOCTYPE html>
<html>
<head>
  <title>Enter Contest</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
     button#checkout_button {
      display: inline-block;
      font-family: sans-serif;
      font-size: 20px;
      background-color: #0BD992;
      color: white;
      border-radius: 4px;
      padding: 14px 28px;
      margin-top: 20px;
      cursor: pointer;
    }
     button#checkout_button:hover {
      background-color: #0AC982;
    }

     button#checkout_button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

  </style>
</head>
<body>
  <h1>Enter Contest - $100 Entry</h1>

  <p style="margin-top: 20px; font-size: 0.95em; color: #444;">
    üèÜ Winners will be contacted via email and asked to provide their full name and mailing address to issue the prize check.<br/>
    <strong>Each contest is seeded (see contest details for exact seed and minimum). The seed is removed if the minimum is not met by contest end.</strong><br/>
    <strong>$100 entry fee: 60% to prize pot, 25% to contest creator for each entry up to the minimum, 30% for every entry above the minimum, 10% reserve, 5% to platform (custom contests).</strong>
  </p>

<label for="state">Select Your Home State: <span style="font-size: 0.85em; color: #666;">(Contests may be restricted in some areas)</span></label>
    <select name="state" id="state" required>
      <option value="">-- Select a State --</option>
      <option value="AL">Alabama</option>
      <option value="AK">Alaska</option>
      <option value="AZ">Arizona</option>
      <option value="AR">Arkansas</option>
      <option value="CA">California</option>
      <option value="CO">Colorado</option>
      <option value="CT">Connecticut</option>
      <option value="DE">Delaware</option>
      <option value="FL">Florida</option>
      <option value="GA">Georgia</option>
      <option value="HI">Hawaii</option>
      <option value="ID">Idaho</option>
      <option value="IL">Illinois</option>
      <option value="IN">Indiana</option>
      <option value="IA">Iowa</option>
      <option value="KS">Kansas</option>
      <option value="KY">Kentucky</option>
      <option value="LA">Louisiana</option>
      <option value="ME">Maine</option>
      <option value="MD">Maryland</option>
      <option value="MA">Massachusetts</option>
      <option value="MI">Michigan</option>
      <option value="MN">Minnesota</option>
      <option value="MS">Mississippi</option>
      <option value="MO">Missouri</option>
      <option value="MT">Montana</option>
      <option value="NE">Nebraska</option>
      <option value="NV">Nevada</option>
      <option value="NH">New Hampshire</option>
      <option value="NJ">New Jersey</option>
      <option value="NM">New Mexico</option>
      <option value="NY">New York</option>
      <option value="NC">North Carolina</option>
      <option value="ND">North Dakota</option>
      <option value="OH">Ohio</option>
      <option value="OK">Oklahoma</option>
      <option value="OR">Oregon</option>
      <option value="PA">Pennsylvania</option>
      <option value="RI">Rhode Island</option>
      <option value="SC">South Carolina</option>
      <option value="SD">South Dakota</option>
      <option value="TN">Tennessee</option>
      <option value="TX">Texas</option>
      <option value="UT">Utah</option>
      <option value="VT">Vermont</option>
      <option value="VA">Virginia</option>
      <option value="WA">Washington</option>
      <option value="WV">West Virginia</option>
      <option value="WI">Wisconsin</option>
      <option value="WY">Wyoming</option>
      <option value="DC">District of Columbia</option>
      <option value="AS">American Samoa</option>
      <option value="GU">Guam</option>
      <option value="MP">Northern Mariana Islands</option>
      <option value="PR">Puerto Rico</option>
      <option value="VI">U.S. Virgin Islands</option>
      <option value="UM">U.S. Minor Outlying Islands</option>
      <option value="FM">Federated States of Micronesia</option>
      <option value="MH">Marshall Islands</option>
      <option value="PW">Palau</option>
</select>

<div id="stateAlert" class="alert" style="display: none;">Contests for cash are not available in your state.</div>

  <button id="checkout_button" disabled>Check Out</button>

  <!-- ‚úÖ EPD Checkout Script -->
  <script
    src="https://secure.easypaydirectgateway.com/token/CollectCheckout.js"
    data-checkout-key="checkout_public_2828BnDCyj2J74bs2Hr7FT5wFN37qg2S"
  ></script>

  <script>
  const restrictedStates = ['NY', 'WA', 'NJ', 'PR', 'GU', 'AS', 'VI', 'MP', 'RI'];
  const stateSelect = document.getElementById('state');
  const submitButton = document.getElementById('checkout_button');
  const stateAlert = document.getElementById('stateAlert');

  function updateSubmitButton() {
    const selectedState = stateSelect.value;
    const isRestricted = restrictedStates.includes(selectedState);
    const allFieldsFilled = selectedState && !isRestricted;

    submitButton.disabled = !allFieldsFilled;
    stateAlert.style.display = isRestricted ? 'block' : 'none';
  }

  stateSelect.addEventListener('change', updateSubmitButton);
  updateSubmitButton(); // ‚úÖ Ensure button is properly initialized

  document.getElementById('checkout_button').addEventListener('click', async function () {
    try {
      const response = await fetch('/api/session');
      if (!response.ok) throw new Error('Failed to get session ID');
      const data = await response.json();
      const sessionId = data.sessionId;

      if (
        typeof CollectCheckout === 'undefined' ||
        typeof CollectCheckout.redirectToCheckout !== 'function'
      ) {
        alert('Checkout is not available right now. Please refresh and try again.');
        return;
      }

      CollectCheckout.redirectToCheckout({
        type: "sale",
        lineItems: [
          {
            lineItemType: "purchase",
            sku: "contest-entry-may2025",
            quantity: 1
          },
        ],
        successUrl: `https://contests-unlimited.onrender.com/success.html?session_id=${sessionId}`,
        cancelUrl: "https://contests-unlimited.onrender.com/cancel.html",
        receipt: {
          showReceipt: false,
          sendToCustomer: true,
        },
        collectShippingInfo: true,
        useKount: false,
        paymentMethods: [
          {
            type: "creditCard",
            use3DSecure: false,
          },
          {
            type: "check",
          },
        ],
        fields: [],
      }).then((error) => {
        if (error) {
          console.error("Checkout redirect error:", error);
        }
      });
    } catch (err) {
      console.error('Error fetching session ID:', err);
      alert('Failed to start checkout session. Please try again.');
    }
  });
</script>
</body>
</html>