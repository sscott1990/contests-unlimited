<!DOCTYPE html> 
<html>
<head>
  <title>Payment Success</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    #triviaSection {
      display: none;
      margin-top: 20px;
      padding: 15px;
      border: 2px solid #007849;
      border-radius: 10px;
      background-color: #f9f9f9;
    }
    .question {
      margin-bottom: 15px;
    }
    #captionImageContainer {
      margin-top: 20px;
    }
    #captionImageContainer img {
      max-width: 100%;
      border: 2px solid #ccc;
      border-radius: 10px;
      display: block;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <h1>Thank you for entering!</h1>

  <p id="prizePoolDisplay" style="max-width:600px;color:#444;font-size:1em;">
    Loading prize pool...
  </p>

  <!-- Image will show here if caption contest -->
  <div id="captionImageContainer"></div>

  <form id="uploadForm" enctype="multipart/form-data" method="POST" action="/api/payment/upload">
    <input type="text" name="name" placeholder="Your Name" required>

    <select name="contestName" id="contestSelect" required>
      <option value="" disabled selected>Select Contest</option>
      <option value="art-contest-default">Art Contest</option>
      <option value="photo-contest-default">Photo Contest</option>
      <option value="trivia-contest-default">Trivia Contest</option>
      <option value="caption-contest-default">Caption Contest</option>
    </select>

    <input type="file" name="file" id="fileInput" accept="image/*" required>
    <input type="hidden" name="session_id" id="sessionIdInput">

    <div id="triviaSection">
      <p><strong>Trivia (10 minutes to complete):</strong></p>
      <div id="triviaQuestions"></div>
      <p><strong>Time left: <span id="timer">10:00</span></strong></p>
    </div>

    <input type="hidden" name="triviaAnswers" id="triviaAnswers">
    <input type="hidden" name="timeTaken" id="timeTaken">

    <button type="submit">Submit Entry</button>
  </form>

  <a href="/">Back to Home</a>

<script>
  const contestSelect = document.getElementById('contestSelect');
  const fileInput = document.getElementById('fileInput');
  const triviaSection = document.getElementById('triviaSection');
  const triviaQuestionsDiv = document.getElementById('triviaQuestions');
  const triviaAnswersInput = document.getElementById('triviaAnswers');
  const timeTakenInput = document.getElementById('timeTaken');
  const sessionIdInput = document.getElementById('sessionIdInput');

  let timer, startTime, triviaQuestions = [];
  let timerStarted = false;
  let contestsData = []; // Store loaded contests data

  const SESSION_KEY = "cu_session_id";
  const urlParams = new URLSearchParams(window.location.search);
  let sessionId = urlParams.get('session_id');

  if (!sessionId) {
    sessionId = localStorage.getItem(SESSION_KEY);
  }

  if (!sessionId) {
    alert('Missing session ID. Please return to the homepage and try again.');
    document.getElementById('uploadForm').style.display = 'none';
  } else {
    sessionIdInput.value = sessionId;
    localStorage.setItem(SESSION_KEY, sessionId);
  }

  contestSelect.addEventListener('change', async function () {
    const selectedOption = contestSelect.options[contestSelect.selectedIndex];
    const isTrivia = selectedOption && selectedOption.textContent.toLowerCase().includes('trivia');

    if (isTrivia) {
      fileInput.disabled = true;
      fileInput.style.display = 'none';
      fileInput.required = false;
      triviaSection.style.display = 'block';

      [...document.querySelectorAll('input[type="radio"]')].forEach(r => r.required = false);
      await loadTriviaQuestions();
      [...triviaQuestionsDiv.querySelectorAll('input[type="radio"]')].forEach(r => r.required = true);

      startTimer();
      timerStarted = true;
    } else {
      fileInput.disabled = false;
      fileInput.style.display = '';
      fileInput.required = true;
      triviaSection.style.display = 'none';
      [...document.querySelectorAll('input[type="radio"]')].forEach(r => r.required = false);
      clearInterval(timer);
      timerStarted = false;
    }

    // Handle caption contest image display
    await handleCaptionImageDisplay();
    updatePrizePoolDisplay();
  });

  async function handleCaptionImageDisplay() {
    const selectedSlug = contestSelect.value;
    const container = document.getElementById('captionImageContainer');
    
    // Clear existing content
    container.innerHTML = '';
    
    // Check if it's a caption contest
    if (!selectedSlug || !selectedSlug.includes('caption')) {
      return;
    }

    try {
      // For default caption contest
      if (selectedSlug === 'caption-contest-default') {
        // You might want to add a default image here or leave empty
        return;
      }

      // For custom caption contests, find the contest data
      const contestData = contestsData.find(contest => contest.slug === selectedSlug);
      
      if (contestData && contestData.fileUrl) {
        const img = document.createElement('img');
        img.src = contestData.fileUrl;
        img.alt = 'Caption Contest Image';
        img.onerror = function() {
          console.error('Failed to load image:', contestData.fileUrl);
          container.innerHTML = '<p style="color: #666; text-align: center;">Image not available</p>';
        };
        
        container.appendChild(img);
        
        // Add contest title and description if available
        if (contestData.contestTitle) {
          const title = document.createElement('h3');
          title.textContent = contestData.contestTitle;
          title.style.textAlign = 'center';
          title.style.marginTop = '10px';
          title.style.color = '#333';
          container.appendChild(title);
        }
        
        if (contestData.description) {
          const description = document.createElement('p');
          description.textContent = contestData.description;
          description.style.textAlign = 'center';
          description.style.marginTop = '10px';
          description.style.fontStyle = 'italic';
          description.style.color = '#666';
          container.appendChild(description);
        }
      }
    } catch (error) {
      console.error('Error handling caption image display:', error);
    }
  }

  async function loadTriviaQuestions() {
    try {
      const slug = contestSelect.value;

      if (slug === "trivia-contest-default") {
        const response = await fetch('/api/trivia?slug=trivia-contest-default');
        triviaQuestions = await response.json();
      } else if (slug.startsWith("trivia-contest-")) {
        let response = await fetch('/api/custom-trivia/by-slug/' + encodeURIComponent(slug));
        if (response.ok) {
          const data = await response.json();
          triviaQuestions = Array.isArray(data.questions) ? data.questions : [];
        } else {
          triviaQuestions = [];
        }
      } else {
        triviaQuestions = [];
      }

      triviaQuestionsDiv.innerHTML = '';
      if (!triviaQuestions || triviaQuestions.length === 0) {
        triviaQuestionsDiv.innerHTML = '<p>No trivia questions available for this contest.</p>';
        document.querySelector('button[type="submit"]').disabled = true;
        return;
      }

      triviaQuestions.forEach((q, index) => {
        const div = document.createElement('div');
        div.classList.add('question');

        const optionsHtml = Object.entries(q.options).map(([key, val]) => `
          <label><input type="radio" name="q${index}" value="${key}" required> ${val}</label><br>
        `).join('');

        div.innerHTML = `<p>${index + 1}. ${q.question}</p>${optionsHtml}`;
        triviaQuestionsDiv.appendChild(div);
      });
      document.querySelector('button[type="submit"]').disabled = false;
    } catch (err) {
      console.error('Error loading trivia:', err);
      triviaQuestionsDiv.innerHTML = '<p>Failed to load trivia questions. Please try again later.</p>';
      document.querySelector('button[type="submit"]').disabled = true;
    }
  }

  function startTimer() {
    let timeLeft = 600;
    startTime = Date.now();

    timer = setInterval(() => {
      timeLeft--;
      const minutes = String(Math.floor(timeLeft / 60)).padStart(2, '0');
      const seconds = String(timeLeft % 60).padStart(2, '0');
      document.getElementById('timer').textContent = `${minutes}:${seconds}`;
      if (timeLeft <= 0) {
        clearInterval(timer);
        lockAnswers();
      }
    }, 1000);
  }

  function lockAnswers() {
    const inputs = triviaSection.querySelectorAll('input[type="radio"]');
    inputs.forEach(input => input.disabled = true);
    alert('Time is up! Answers are now locked.');
  }

  document.getElementById('uploadForm').addEventListener('submit', function () {
    const selectedOption = contestSelect.options[contestSelect.selectedIndex];
    const isTrivia = selectedOption && selectedOption.textContent.toLowerCase().includes('trivia');
    if (isTrivia) {
      const answers = triviaQuestions.map((q, i) => {
        const selected = document.querySelector(`input[name="q${i}"]:checked`);
        return {
          question: q.question,
          selected: selected ? selected.value : null,
          correct: selected ? selected.value === q.answer : false
        };
      });
      triviaAnswersInput.value = JSON.stringify(answers);
      timeTakenInput.value = ((Date.now() - startTime) / 1000);
    }
  });

  async function loadApprovedContests() {
    try {
      const res = await fetch('/api/contests/approved');
      const contests = await res.json();
      
      // Store contests data for later use
      contestsData = contests;

      const defaultSlugs = [
        "art-contest-default",
        "photo-contest-default",
        "trivia-contest-default",
        "caption-contest-default"
      ];
      const filtered = contests.filter(c =>
        !defaultSlugs.includes(c.slug)
      );
      filtered.sort((a, b) =>
        (a.contestTitle || a.name || a.slug).localeCompare(b.contestTitle || b.name || b.slug)
      );

      filtered.forEach(contest => {
        const option = document.createElement('option');
        option.value = contest.slug;
        option.textContent = contest.contestTitle || contest.name || contest.slug;
        contestSelect.appendChild(option);
      });
    } catch (err) {
      console.error('Failed to load contests:', err);
    }
  }

  loadApprovedContests();

  // Show caption image and pre-select contest if applicable
  const type = urlParams.get('type');
  const imgParam = urlParams.get('img');
  const imgSlug = urlParams.get('slug');

  if (type === 'caption' && imgParam && imgSlug && imgSlug.startsWith('caption-contest-')) {
    contestSelect.value = imgSlug; // Pre-select the contest
    const img = document.createElement('img');
    img.src = decodeURIComponent(imgParam);
    img.alt = 'Caption Contest Image';
    img.style.maxWidth = '100%';
    img.style.border = '2px solid #ccc';
    img.style.borderRadius = '10px';
    img.style.marginTop = '20px';

    const container = document.getElementById('captionImageContainer');
    container.innerHTML = '';
    container.appendChild(img);
  }

  window.addEventListener('DOMContentLoaded', async () => {
    // Wait for contests to load first
    await loadApprovedContests();
    
    if (contestSelect.value && contestSelect.options[contestSelect.selectedIndex].textContent.toLowerCase().includes('trivia')) {
      fileInput.disabled = true;
      fileInput.style.display = 'none';
      fileInput.required = false;
      triviaSection.style.display = 'block';
      loadTriviaQuestions();
      startTimer();
      timerStarted = true;
    }
    
    // Handle caption image display for pre-selected contests
    await handleCaptionImageDisplay();
    updatePrizePoolDisplay();
  });

  async function updatePrizePoolDisplay() {
    const contestSlug = contestSelect.value;
    const display = document.getElementById('prizePoolDisplay');
    if (!contestSlug) {
      display.innerHTML = `
        <strong>Entry fee: $100.</strong><br>
        <strong>Prize pool:</strong> Select a contest to see the live prize pool.
      `;
      return;
    }
    try {
      const res = await fetch('/api/prize');
      const prizes = await res.json();

      let prizeData = prizes[contestSlug];
      if (!prizeData) {
        const platformMap = {
          "art-contest-default": "Art Contest",
          "photo-contest-default": "Photo Contest",
          "trivia-contest-default": "Trivia Contest",
          "caption-contest-default": "Caption Contest"
        };
        if (platformMap[contestSlug]) {
          prizeData = prizes[platformMap[contestSlug]];
        }
      }
      if (!prizeData) {
        display.innerHTML = `<strong>Entry fee: $100.</strong><br>Prize pool: Not available.`;
        return;
      }

      const { pot, totalEntries, seedAmount, seedIncluded, minEntries, durationMonths, contestTitle } = prizeData;
      let duration = "1 month";
      if (durationMonths === 3) duration = "3 months";
      else if (durationMonths === 6) duration = "6 months";
      else if (durationMonths === 12) duration = "1 year";

      display.innerHTML =
        `<strong>Entry fee: $100.</strong><br>
        <strong>Prize pool: $${pot.toFixed(2)}</strong> ${seedIncluded ? `(includes $${seedAmount} seed unlocked!)` : `(seed not unlocked, needs ${minEntries - totalEntries} more entries)`}<br>
        Entries: <strong>${totalEntries}</strong> &mdash; Duration: ${duration}<br>
        Winner receives 60% of all entry fees (plus seed if unlocked).<br>
        <small style="color:#666;">Seed/minimums: 1 month: $250/50, 3 months: $500/100, 6 months: $750/150, 1 year: $1000/200. If minimum not met, winner still receives 60% of all entry fees. Payouts: 60% to prize pot (always to winner), 25% to contest creator to minimum, 30% for every entry above minimum, 10% reserve, 5% platform (custom contests). Winners will be contacted via email for prize delivery.</small>
        `;
    } catch (e) {
      display.textContent = "Unable to load prize pool.";
    }
  }
</script>
</body>
</html>