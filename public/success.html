<!DOCTYPE html> 
<html>
<head>
  <title>Payment Success</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    #triviaSection {
      display: none;
      margin-top: 20px;
      padding: 15px;
      border: 2px solid #007849;
      border-radius: 10px;
      background-color: #f9f9f9;
    }
    .question {
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <h1>Thank you for entering!</h1>

  <p id="prizePoolDisplay" style="max-width:600px;color:#444;font-size:1em;">
    Loading prize pool...
  </p>

  <div id="captionImageContainer"></div>

  <form id="uploadForm" enctype="multipart/form-data" method="POST" action="/api/payment/upload">
    <input type="text" name="name" placeholder="Your Name" required>

    <select name="contestName" id="contestSelect" required>
      <option value="" disabled selected>Select Contest</option>
      <option value="art-contest-default">Art Contest</option>
      <option value="photo-contest-default">Photo Contest</option>
      <option value="trivia-contest-default">Trivia Contest</option>
      <option value="caption-contest-default">Caption Contest</option>
    </select>

    <input type="file" name="file" id="fileInput" accept="image/*" required>
    <input type="hidden" name="session_id" id="sessionIdInput">

    <div id="triviaSection">
      <p><strong>Trivia (10 minutes to complete):</strong></p>
      <div id="triviaQuestions"></div>
      <p><strong>Time left: <span id="timer">10:00</span></strong></p>
    </div>

    <input type="hidden" name="triviaAnswers" id="triviaAnswers">
    <input type="hidden" name="timeTaken" id="timeTaken">

    <button type="submit">Submit Entry</button>
  </form>

  <a href="/">Back to Home</a>

<script>
const contestSelect = document.getElementById('contestSelect');
const fileInput = document.getElementById('fileInput');
const triviaSection = document.getElementById('triviaSection');
const triviaQuestionsDiv = document.getElementById('triviaQuestions');
const triviaAnswersInput = document.getElementById('triviaAnswers');
const timeTakenInput = document.getElementById('timeTaken');
const sessionIdInput = document.getElementById('sessionIdInput');
const captionImageContainer = document.getElementById('captionImageContainer');

let timer, startTime, triviaQuestions = [];
let timerStarted = false;
let creatorData = [];

const SESSION_KEY = "cu_session_id";
const urlParams = new URLSearchParams(window.location.search);
let sessionId = urlParams.get('session_id');

if (!sessionId) {
    sessionId = localStorage.getItem(SESSION_KEY);
}

if (!sessionId) {
    alert('Missing session ID. Please return to the homepage and try again.');
    document.getElementById('uploadForm').style.display = 'none';
} else {
    sessionIdInput.value = sessionId;
    localStorage.setItem(SESSION_KEY, sessionId);
}

// Fetch creator data once on page load
async function fetchCreatorData() {
    try {
        const response = await fetch("https://your-s3-bucket-url/creator.json");
        creatorData = await response.json();
    } catch (error) {
        console.error("Error fetching creator data:", error);
        creatorData = [];
    }
}

fetchCreatorData();

contestSelect.addEventListener('change', async function () {
    const selectedSlug = contestSelect.value;
    const selectedOption = contestSelect.options[contestSelect.selectedIndex];
    const isTrivia = selectedOption && selectedOption.textContent.toLowerCase().includes('trivia');

    if (isTrivia) {
        fileInput.disabled = true;
        fileInput.style.display = 'none';
        fileInput.required = false;
        triviaSection.style.display = 'block';

        [...document.querySelectorAll('input[type="radio"]')].forEach(r => r.required = false);
        await loadTriviaQuestions();
        [...triviaQuestionsDiv.querySelectorAll('input[type="radio"]')].forEach(r => r.required = true);

        startTimer();
        timerStarted = true;
    } else {
        fileInput.disabled = false;
        fileInput.style.display = '';
        fileInput.required = true;
        triviaSection.style.display = 'none';
        [...document.querySelectorAll('input[type="radio"]')].forEach(r => r.required = false);
        clearInterval(timer);
        timerStarted = false;
    }

    updatePrizePoolDisplay();

    if (selectedSlug.startsWith("caption-contest-")) {
        const contest = creatorData.find(item => item.slug === selectedSlug);
        captionImageContainer.innerHTML = contest && contest.fileUrl ? 
            `<img src="${contest.fileUrl}" alt="Caption Contest Image" style="max-width: 100%; border: 2px solid #ccc; border-radius: 10px; margin-top: 20px;">` 
            : "";
    } else {
        captionImageContainer.innerHTML = "";
    }
});

// Keep existing logic for prize pool updates
async function updatePrizePoolDisplay() {
    const contestSlug = contestSelect.value;
    const display = document.getElementById('prizePoolDisplay');
    if (!contestSlug) {
        display.innerHTML = `<strong>Entry fee: $100.</strong><br><strong>Prize pool:</strong> Select a contest to see the live prize pool.`;
        return;
    }
    try {
        const res = await fetch('/api/prize');
        const prizes = await res.json();
        let prizeData = prizes[contestSlug];

        if (!prizeData) {
            const platformMap = {
                "art-contest-default": "Art Contest",
                "photo-contest-default": "Photo Contest",
                "trivia-contest-default": "Trivia Contest",
                "caption-contest-default": "Caption Contest"
            };
            if (platformMap[contestSlug]) {
                prizeData = prizes[platformMap[contestSlug]];
            }
        }
        if (!prizeData) {
            display.innerHTML = `<strong>Entry fee: $100.</strong><br>Prize pool: Not available.`;
            return;
        }

        const { pot, totalEntries, seedAmount, seedIncluded, minEntries, durationMonths, contestTitle } = prizeData;
        let duration = "1 month";
        if (durationMonths === 3) duration = "3 months";
        else if (durationMonths === 6) duration = "6 months";
        else if (durationMonths === 12) duration = "1 year";

        display.innerHTML =
            `<strong>Entry fee: $100.</strong><br>
            <strong>Prize pool: $${pot.toFixed(2)}</strong> ${seedIncluded ? `(includes $${seedAmount} seed unlocked!)` : `(seed not unlocked, needs ${minEntries - totalEntries} more entries)`}<br>
            Entries: <strong>${totalEntries}</strong> &mdash; Duration: ${duration}<br>
            Winner receives 60% of all entry fees (plus seed if unlocked).<br>
            <small style="color:#666;">Seed/minimums: 1 month: $250/50, 3 months: $500/100, 6 months: $750/150, 1 year: $1000/200.</small>`;
    } catch (e) {
        display.textContent = "Unable to load prize pool.";
    }
}

window.addEventListener('DOMContentLoaded', () => {
    fetchCreatorData();
    updatePrizePoolDisplay();
});
</script>
</body>
</html>
