<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Create a Contest</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <h1>Create a Contest</h1>

  <form id="creatorForm" action="/api/creator/upload" method="POST">
    <input type="hidden" id="session_id" name="session_id" />

    <label for="name">Your Name:</label>
    <input type="text" name="name" required />

    <label for="email">Your Email:</label>
    <input type="email" name="email" required />

    <label for="contestTitle">Contest Title:</label>
    <input type="text" name="contestTitle" required />

    <label for="description">Contest Description:</label>
    <textarea name="description" required></textarea>

    <label for="prizeModel">Prize Model:</label>
    <select name="prizeModel" required>
      <option value="$1/entry to you, $2.50 to prize pool, $1.50 to us">
        $1/entry to you, $2.50 to prize pool, $1.50 to us
      </option>
    </select>

    <button type="submit">Submit Contest Info</button>
  </form>

  <button id="payButton">Pay $50 to Create Contest</button>

  <script src="https://secure.easypaydirectgateway.com/js/collectcheckout.js"></script>
  <script>
    let creatorSessionId = null;

    // Step 1: Fetch session ID when page loads
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const res = await fetch('/api/creator/session');
        const data = await res.json();
        creatorSessionId = data.creatorSessionId;

        // Populate the hidden input
        document.getElementById('session_id').value = creatorSessionId;
      } catch (err) {
        console.error('Failed to fetch creator session ID:', err);
        alert('Error preparing contest session. Please try again.');
      }
    });

    // Step 2: Handle payment button click
    document.getElementById('payButton').addEventListener('click', function () {
      if (!creatorSessionId) {
        alert("Session ID not ready. Try again in a moment.");
        return;
      }

// Save form values before redirecting to payment
const form = document.getElementById('creatorForm');
localStorage.setItem('creator_name', form.name.value);
localStorage.setItem('creator_email', form.email.value);
localStorage.setItem('creator_contestTitle', form.contestTitle.value);
localStorage.setItem('creator_description', form.description.value);
localStorage.setItem('creator_prizeModel', form.prizeModel.value);

      CollectCheckout.redirectToCheckout({
        paymentGatewayId: "GG8TL79V38",
        amount: 5000, // $50 in cents
        currency: "USD",
        billingAddressRequired: true,
        collectShippingAddress: false,
        successUrl: `https://contests-unlimited.onrender.com/success-creator-submitted.html?session_id=${creatorSessionId}`,
        cancelUrl: "https://contests-unlimited.onrender.com/cancel.html"
      });
    });
  </script>
</body>
</html>
