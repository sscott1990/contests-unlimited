<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Create a Contest</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/styles.css">
  <style>
    form {
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
      background: #f9f9f9;
    }
    label {
      display: block;
      margin-top: 15px;
    }
    input, textarea, select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
    }
    .alert {
      margin-top: 10px;
      color: red;
      font-size: 0.9em;
    }
    #submit_button {
      display: block;
      font-family: sans-serif;
      font-size: 20px;
      background-color: #0BD992;
      color: white;
      border-radius: 4px;
      padding: 14px 28px;
      margin-top: 20px;
      cursor: not-allowed;
      text-align: center;
      opacity: 0.6;
      border: none;
      transition: background 0.15s, opacity 0.15s, cursor 0.15s;
    }
    #submit_button:enabled {
      opacity: 1;
      cursor: pointer;
    }
    .terms-section {
      max-width: 750px;
      margin: 40px auto 0 auto;
      background: #fff;
      border: 2px solid #007849;
      border-radius: 10px;
      padding: 24px 30px 20px 30px;
      font-size: 1em;
      color: #222;
      box-shadow: 0 3px 8px rgba(0,0,0,0.10);
    }
    .terms-section h3 {
      color: #005b96;
      margin-top: 0;
    }
    .terms-section ul {
      padding-left: 20px;
    }
    .home-btn {
      display: block;
      margin: 35px auto 0 auto;
      padding: 14px 38px;
      background: #007849;
      color: #fff;
      font-size: 1.1em;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      transition: background 0.15s;
    }
    .home-btn:hover {
      background: #005b96;
    }
    .trivia-builder-section {
      max-width: 700px;
      margin: 40px auto;
      background: #f7faff;
      border: 2px solid #005b96;
      border-radius: 10px;
      padding: 20px 24px 10px 24px;
      font-size: 1em;
      color: #223;
      box-shadow: 0 3px 8px rgba(0,0,0,0.10);
      display: none;
    }
    .trivia-builder-section h3 {
      margin-top: 0;
      color: #005b96;
    }
    .trivia-question {
      margin: 18px 0;
      padding-bottom: 10px;
      border-bottom: 1px solid #e0e0e0;
    }
    .trivia-builder-section input[type="text"], 
    .trivia-builder-section input[type="radio"] {
      margin: 4px 0;
      width: auto;
    }
    .trivia-options-list {
      margin-bottom: 10px;
    }
    .trivia-actions {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1 style="color:red">HELLO TEST</h1>
  <h1 style="text-align: center;">Submit Your Contest</h1>
  <form id="contestForm" onsubmit="return false;">
    <label for="contestType">Select Contest Type:</label>
    <select name="contestName" id="contestType" required>
      <option value="">-- Select a Contest Type --</option>
      <option value="Art Contest">Art Contest</option>
      <option value="Photo Contest">Photo Contest</option>
      <option value="Trivia Contest">Trivia Contest</option>
      <option value="Caption Contest">Caption Contest</option>
    </select>

    <label for="description">Description:</label>
    <textarea name="description" id="description" rows="5" required></textarea>

    <label for="creator">Your Name:</label>
    <input type="text" name="creator" id="creator" required>

    <label for="email">Email Address:</label>
    <input type="email" name="email" id="email" required>

    <label for="state">Select Your Home State:</label>
    <select name="state" id="state" required>
      <option value="">-- Select a State --</option>
      <option value="AL">Alabama</option>
      <option value="AK">Alaska</option>
      <option value="AZ">Arizona</option>
      <option value="AR">Arkansas</option>
      <option value="CA">California</option>
      <option value="CO">Colorado</option>
      <option value="CT">Connecticut</option>
      <option value="DE">Delaware</option>
      <option value="FL">Florida</option>
      <option value="GA">Georgia</option>
      <option value="HI">Hawaii</option>
      <option value="ID">Idaho</option>
      <option value="IL">Illinois</option>
      <option value="IN">Indiana</option>
      <option value="IA">Iowa</option>
      <option value="KS">Kansas</option>
      <option value="KY">Kentucky</option>
      <option value="LA">Louisiana</option>
      <option value="ME">Maine</option>
      <option value="MD">Maryland</option>
      <option value="MA">Massachusetts</option>
      <option value="MI">Michigan</option>
      <option value="MN">Minnesota</option>
      <option value="MS">Mississippi</option>
      <option value="MO">Missouri</option>
      <option value="MT">Montana</option>
      <option value="NE">Nebraska</option>
      <option value="NV">Nevada</option>
      <option value="NH">New Hampshire</option>
      <option value="NJ">New Jersey</option>
      <option value="NM">New Mexico</option>
      <option value="NY">New York</option>
      <option value="NC">North Carolina</option>
      <option value="ND">North Dakota</option>
      <option value="OH">Ohio</option>
      <option value="OK">Oklahoma</option>
      <option value="OR">Oregon</option>
      <option value="PA">Pennsylvania</option>
      <option value="RI">Rhode Island</option>
      <option value="SC">South Carolina</option>
      <option value="SD">South Dakota</option>
      <option value="TN">Tennessee</option>
      <option value="TX">Texas</option>
      <option value="UT">Utah</option>
      <option value="VT">Vermont</option>
      <option value="VA">Virginia</option>
      <option value="WA">Washington</option>
      <option value="WV">West Virginia</option>
      <option value="WI">Wisconsin</option>
      <option value="WY">Wyoming</option>
      <option value="DC">District of Columbia</option>
      <option value="AS">American Samoa</option>
      <option value="GU">Guam</option>
      <option value="MP">Northern Mariana Islands</option>
      <option value="PR">Puerto Rico</option>
      <option value="VI">U.S. Virgin Islands</option>
      <option value="UM">U.S. Minor Outlying Islands</option>
      <option value="FM">Federated States of Micronesia</option>
      <option value="MH">Marshall Islands</option>
      <option value="PW">Palau</option>
    </select>
    <div id="stateAlert" class="alert" style="display: none;">Contests for cash are not available in your state.</div>

    <label>
      <input type="checkbox" id="agreeTax" required>
      I agree that I am responsible for my own taxes and operations (not an employee).
    </label>

    <label>
      <input type="checkbox" id="agree18" required>
      I confirm that I am 18 years of age or older.
    </label>

    <label>
      <input type="checkbox" id="agreeFees" required>
      I understand that my contest submission is subject to approval and may be rejected if it does not comply with platform rules.
    </label>

    <!-- Password field for creator account -->
    <label for="password">Create a password:</label>
    <input type="password" name="password" id="password" required autocomplete="new-password">

    <!-- Trivia builder appears only if "Trivia Contest" is selected -->
    <div class="trivia-builder-section" id="triviaBuilder">
      <h3>Build Your Trivia (at least 1 question required)</h3>
      <div id="triviaQuestionsContainer"></div>
      <div class="trivia-actions">
        <button type="button" id="addTriviaQuestion">+ Add Question</button>
      </div>
    </div>
    <input type="hidden" name="triviaQuestions" id="triviaQuestionsInput">

    <p><strong>Admission: <span style="color:green;">Free</span> (no charge to submit your contest)</strong></p>

    <button id="submit_button" type="button" disabled>Submit</button>
  </form>

  <a class="home-btn" href="/">← Back to Homepage</a>

  <div class="terms-section">
    <h3>Terms and Conditions for Contest Creators</h3>
    <ul>
      <li>Submitting a contest is <strong>free</strong>. There is no fee to create or submit a contest for approval.</li>
      <li>You must be <strong>18 years of age or older</strong> to create a contest.</li>
      <li>Contests are <strong>void where prohibited</strong> by law. It is your responsibility to ensure that operating a contest is legal in your jurisdiction.</li>
      <li>Each contest will have a unique prize pool funded by participant entries, seeded with $1000 if there is at least 1 entry and at least 20 total entries by contest close for the seed to remain. Payouts: 60% of each $100 entry to the prize pot, 25% to you as creator, 10% to reserve, and 5% to platform (for custom contests).</li>
      <li>At the conclusion of the contest, a single winner will be selected and awarded the full prize pool amount. Winners are notified and paid within 7–14 business days after verification.</li>
      <li>Contest creators are responsible for ensuring fair play and compliance with all stated contest rules.</li>
      <li>Attempts to manipulate, defraud, or otherwise compromise the integrity of any contest will result in disqualification and potential forfeiture of rewards.</li>
      <li>By creating a contest, you agree to abide by all platform policies and the decisions of the contest administrators, which are final.</li>
    </ul>

    <h3>Refund Policy</h3>
    <p>
      As there is no fee to submit a contest, there are no refunds or charges for submissions. If a contest is denied, no funds will be collected. By submitting your contest, you acknowledge and agree to these policies.
    </p>

    <h3>Privacy Policy</h3>
    <p>
      We collect information from contest creators, including names, email addresses, contest descriptions, and related materials, solely for the purpose of operating and managing contests on our platform. All information is securely stored and is not shared, sold, or disclosed to third parties except as required by law or for the purposes of contest administration. Files and data are stored in AWS S3 and processed only for contest verification, administration, and winner selection. By creating a contest, you consent to this data usage and our privacy practices.
    </p>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log("JS loaded!");

      // -- State restriction and submit enable logic --
      const restrictedStates = ['NY', 'WA', 'NJ', 'PR', 'GU', 'AS', 'VI', 'MP', 'RI']; // Modify as needed
      const stateSelect = document.getElementById('state');
      const submitButton = document.getElementById('submit_button');
      const stateAlert = document.getElementById('stateAlert');
      const form = document.getElementById('contestForm');
      const passwordInput = document.getElementById('password');
      const checkboxes = ['agreeTax', 'agree18', 'agreeFees'].map(id => document.getElementById(id));
      const contestType = document.getElementById('contestType');
      const triviaBuilder = document.getElementById('triviaBuilder');
      const triviaQuestionsContainer = document.getElementById('triviaQuestionsContainer');
      const triviaQuestionsInput = document.getElementById('triviaQuestionsInput');
      const descriptionInput = document.getElementById('description');
      const creatorInput = document.getElementById('creator');
      const emailInput = document.getElementById('email');

      let creatorSessionId = null;
      let triviaQuestions = [];

      function updateSubmitButton() {
        const allChecked = checkboxes.every(cb => cb.checked);
        const selectedState = stateSelect.value;
        const isRestricted = restrictedStates.includes(selectedState);
        const passwordFilled = passwordInput.value.trim().length > 0;
        const allFieldsFilled =
          form.elements['contestName'].value &&
          descriptionInput.value &&
          creatorInput.value &&
          emailInput.value &&
          selectedState &&
          allChecked &&
          passwordFilled &&
          creatorSessionId &&
          !isRestricted;
        // For trivia: at least 1 question required
        const isTrivia = contestType.value === "Trivia Contest";
        const triviaReady = !isTrivia || (triviaQuestions.length > 0 && triviaQuestions.every(q => q.question && Object.keys(q.options).length >= 2 && q.answer));
        submitButton.disabled = !(allFieldsFilled && triviaReady);

        stateAlert.style.display = isRestricted ? 'block' : 'none';
      }

      // Fetch creatorSessionId from backend before enabling submit
      fetch('/api/creator/session')
        .then(res => res.json())
        .then(data => {
          creatorSessionId = data.creatorSessionId;
          updateSubmitButton();
        })
        .catch(err => {
          console.error('Failed to fetch creator session ID:', err);
        });

      stateSelect.addEventListener('change', updateSubmitButton);
      checkboxes.forEach(cb => cb.addEventListener('change', updateSubmitButton));
      passwordInput.addEventListener('input', updateSubmitButton);
      descriptionInput.addEventListener('input', updateSubmitButton);
      creatorInput.addEventListener('input', updateSubmitButton);
      emailInput.addEventListener('input', updateSubmitButton);

      // -- Trivia Builder Logic --
      contestType.addEventListener('change', function () {
        console.log("Dropdown changed to", contestType.value);
        if (contestType.value === "Trivia Contest") {
          console.log("Should show triviaBuilder now");
          triviaBuilder.style.display = 'block'; // <-- FIXED: use 'block' to override CSS
          if (triviaQuestions.length === 0) addQuestion();
        } else {
          triviaBuilder.style.display = 'none';
          triviaQuestions = [];
          triviaQuestionsContainer.innerHTML = '';
          triviaQuestionsInput.value = '';
        }
        updateSubmitButton();
      });

      document.getElementById('addTriviaQuestion').addEventListener('click', addQuestion);

      function addQuestion() {
        const questionIndex = triviaQuestions.length;
        const questionObj = { question: '', options: {}, answer: '' };
        triviaQuestions.push(questionObj);

        const div = document.createElement('div');
        div.className = 'trivia-question';
        div.id = 'trivia-q-' + questionIndex;

        div.innerHTML = `
          <label>Question ${questionIndex + 1}:</label>
          <input type="text" class="trivia-question-input" placeholder="Enter question text" required><br>
          <div class="trivia-options-list">
            <label>Options (min 2):</label>
            <div>
              <input type="text" class="trivia-option-input" data-key="A" placeholder="Option A" required>
              <input type="radio" name="trivia-answer-${questionIndex}" class="trivia-answer-radio" value="A" required> Correct
            </div>
            <div>
              <input type="text" class="trivia-option-input" data-key="B" placeholder="Option B" required>
              <input type="radio" name="trivia-answer-${questionIndex}" class="trivia-answer-radio" value="B"> Correct
            </div>
            <div>
              <input type="text" class="trivia-option-input" data-key="C" placeholder="Option C">
              <input type="radio" name="trivia-answer-${questionIndex}" class="trivia-answer-radio" value="C"> Correct
            </div>
            <div>
              <input type="text" class="trivia-option-input" data-key="D" placeholder="Option D">
              <input type="radio" name="trivia-answer-${questionIndex}" class="trivia-answer-radio" value="D"> Correct
            </div>
          </div>
          <button type="button" class="remove-question-btn" style="color:#a00;margin-top:8px;">Remove Question</button>
        `;
        triviaQuestionsContainer.appendChild(div);

        // Wire up listeners for this question
        const questionInput = div.querySelector('.trivia-question-input');
        const optionInputs = Array.from(div.querySelectorAll('.trivia-option-input'));
        const answerRadios = Array.from(div.querySelectorAll('.trivia-answer-radio'));
        const removeBtn = div.querySelector('.remove-question-btn');

        questionInput.addEventListener('input', () => {
          questionObj.question = questionInput.value;
          updateTriviaQuestionsInput();
        });
        optionInputs.forEach(input => {
          input.addEventListener('input', () => {
            const key = input.getAttribute('data-key');
            if (input.value.trim()) {
              questionObj.options[key] = input.value;
            } else {
              delete questionObj.options[key];
            }
            updateTriviaQuestionsInput();
          });
        });
        answerRadios.forEach(radio => {
          radio.addEventListener('change', () => {
            if (radio.checked) questionObj.answer = radio.value;
            updateTriviaQuestionsInput();
          });
        });
        removeBtn.addEventListener('click', () => {
          triviaQuestions.splice(questionIndex, 1);
          div.remove();
          updateTriviaQuestionsInput();
          updateSubmitButton();
          // Re-number remaining questions
          Array.from(triviaQuestionsContainer.children).forEach((child, idx) => {
            child.querySelector('label').textContent = `Question ${idx + 1}:`;
          });
        });

        updateTriviaQuestionsInput();
        updateSubmitButton();
      }

      function updateTriviaQuestionsInput() {
        // Remove empty/incomplete questions (not enough options, no question, no answer)
        const validQuestions = triviaQuestions
          .map(q => ({
            question: q.question,
            options: Object.fromEntries(Object.entries(q.options).filter(([k, v]) => v && v.trim())),
            answer: q.answer
          }))
          .filter(q =>
            q.question &&
            Object.keys(q.options).length >= 2 &&
            q.answer &&
            q.options[q.answer]
          );
        triviaQuestionsInput.value = JSON.stringify(validQuestions);
        updateSubmitButton();
      }

      submitButton.addEventListener('click', async function () {
        if (submitButton.disabled) return;
        // Prepare form data
        const formData = {
          contestName: form.elements['contestName'].value,
          description: descriptionInput.value,
          creator: creatorInput.value,
          email: emailInput.value,
          state: form.elements['state'].value,
          password: form.elements['password'].value,
          creatorSessionId,
          // --- FIX: always send parsed triviaQuestions as an array if present ---
          triviaQuestions: (contestType.value === "Trivia Contest" && triviaQuestionsInput.value)
            ? JSON.parse(triviaQuestionsInput.value)
            : undefined
        };
        try {
          const response = await fetch('/api/creator/upload', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });
          if (response.redirected) {
            window.location.href = response.url;
          } else if (response.ok) {
            window.location.href = "/success-creator-submitted.html";
          } else {
            const errMsg = await response.text();
            alert('Submission error: ' + errMsg);
          }
        } catch (err) {
          alert('Submission failed: ' + err.message);
        }
      });
    });
  </script>
</body>
</html>