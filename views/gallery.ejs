<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gallery - All Contest Uploads</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body class="gallery-background">
  <div class="container">
    <h1>Gallery of Contest Uploads</h1>

    <!-- Search Bar -->
    <form class="gallery-search-bar" style="margin-bottom: 2rem;" method="get" action="/gallery">
      <input
        type="text"
        name="search"
        value="<%= typeof search !== 'undefined' ? search.replace(/"/g, "&quot;") : '' %>"
        placeholder="Search by contest name, entrant name, or host..."
        style="padding: 8px 12px; min-width: 250px; font-size: 1em;"
      />
      <button type="submit" style="padding: 8px 18px;">Search</button>
    </form>

    <div class="gallery-grid">
      <% uploads.forEach(function(upload) { %>
        <div class="gallery-card">
          <span class="gallery-tag"><%= upload.contestName || 'Unknown' %></span>
          <% 
            // --- PATCH: Default Caption Contest ---
            if (
              upload.contestName === 'caption-contest-default' &&
              upload.contestImageUrl && upload.captionText
            ) { 
          %>
            <img class="gallery-img" src="<%= upload.contestImageUrl %>" alt="Caption Contest Image">
            <div class="caption-block">
              <strong>Caption:</strong> <span><%= upload.captionText %></span>
            </div>
          <% 
            // --- END PATCH ---
            // If it's a custom caption contest and a caption was submitted, 
            // show the contest image and the caption text 
            } else if (
              upload.contestName && 
              upload.contestName.startsWith('caption-contest-') && 
              upload.contestName !== 'caption-contest-default' &&
              upload.contestImageUrl && upload.captionText
            ) { 
          %>
            <img class="gallery-img" src="<%= upload.contestImageUrl %>" alt="Caption Contest Image">
            <div class="caption-block">
              <strong>Caption:</strong> <span><%= upload.captionText %></span>
            </div>
          <% 
            // Show the uploaded image if present and not a caption contest with caption
            } else if (upload.presignedUrl && upload.isImageFile) { 
          %>
            <img class="gallery-img" src="<%= upload.presignedUrl %>" alt="Upload by <%= upload.name %>">
          <% 
            } else { 
          %>
            <div class="no-image">No Image</div>
          <% } %>
          <div class="gallery-info">
            <div><strong>Name:</strong> <%= upload.name || 'Anonymous' %></div>
            <div><strong>Contest:</strong> <%= upload.contestName || 'Unknown' %></div>
            <div><strong>Host:</strong> <%= upload.host || 'Contests Unlimited' %></div>
            <div class="date"><strong>Date:</strong> <%= new Date(upload.timestamp).toLocaleDateString() %></div>
          </div>
        </div>
      <% }); %>
    </div>

    <!-- Pagination Controls -->
    <% if (totalPages && totalPages > 1) { %>
      <nav class="pagination">
        <% if (page > 1) { %>
          <a href="?<% if (typeof search !== 'undefined' && search) { %>search=<%= encodeURIComponent(search) %>&<% } %>page=<%= page - 1 %>">&laquo; Previous</a>
        <% } else { %>
          <span class="disabled">&laquo; Previous</span>
        <% } %>
        <% for (var i = 1; i <= totalPages; i++) { %>
          <% if (i === page) { %>
            <span class="current"><%= i %></span>
          <% } else { %>
            <a href="?<% if (typeof search !== 'undefined' && search) { %>search=<%= encodeURIComponent(search) %>&<% } %>page=<%= i %>"><%= i %></a>
          <% } %>
        <% } %>
        <% if (page < totalPages) { %>
          <a href="?<% if (typeof search !== 'undefined' && search) { %>search=<%= encodeURIComponent(search) %>&<% } %>page=<%= page + 1 %>">Next &raquo;</a>
        <% } else { %>
          <span class="disabled">Next &raquo;</span>
        <% } %>
      </nav>
    <% } %>
  </div>
</body>
</html>